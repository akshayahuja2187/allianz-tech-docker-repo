pipeline {
  agent any
  stages {
    stage('Start k3d cluster') {
      steps {
        sh 'k3d cluster create my-cluster --wait'
      }
    }
    stage('Deploy image') {
      steps {
        sh 'kubectl apply -f deployment.yaml'
      }
    }
    stage('Delete cluster') {
      steps {
        sh 'k3d cluster delete my-cluster'
      }
    }
  }
  triggers {
    upstream {
      upstreamJob 'my-build-job'
      triggerOnChanges true
    }
  }
}